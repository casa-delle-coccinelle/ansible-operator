
### ansible-operator
Operator for managing execution of ansible playbooks as cronjobs and jobs in a Kubernetes cluster.

<picture>
  <source media="(prefers-color-scheme: dark)" srcset="./images/overview-dark.png">
  <source media="(prefers-color-scheme: light)" srcset="./images/overview-light.png">
  <img alt="Switch image." src="./images/overview-light.png">
</picture>

Once installed, it will watch all namespaces for resources of type ansiblejobs and ansiblecrons. For each resource type it will create Kubernetes job or cronjob in the same namespace as the CRD to run the ansible executor pod. Currently supported configurations for an ansible playbook are:
- ***ansible playbook*** - the playbook to be executed can be provided as Kubernetes secret, configmap or located in a git repository. Currently private repositories are cloned only using SSH, so at least one SSH key should be provided in order to clone the repository.
- ***requirements*** - can be provided via CRD or in a git repository. If both are defined, all roles and collections will be installed prior running the playbook.
- ***inventory*** - can be provided as Kubernetes secrets and configmaps. The operator will mount all secrets/configmaps onto executor's pod and executor_start.sh will provide all of them to the ansible-playbook command.
- ***variables*** - can be provided as Kubernetes secrets, configmaps and name/value pair. The operator will create a configmap with name/value for each variable and the operator will mount all secrets/configmaps onto executor's pod. All files with variables will be supplied to the ansible-playbook command (with @file) in executor_start.sh
- ***playbook options*** - can be provided as list in CRDs. The operator will create configmap with each option one per line and mount it onto executor's pod. executor_start.sh will supply all the options to the ansible playbook command as defined without making any verifications.
- ***SSH keys*** - can be provided as Kubernetes secrets. The operator will mount all secrets onto executor's pod.
- ***SSH client configuration*** - can be provided as Kubernetes secrets or configmaps.  The operator will mount all secrets/configmaps onto executor's pod. SSH configuration file (/home/ansible/.ssh/config) will be generated by executor_start.sh prior running the playbook

### Installation
To install the operator to your Kubernetes cluster you should have helm installed.

    git clone https://github.com/casa-delle-coccinelle/ansible-operator.git
    cd ansible-operator/
    kubectl apply -f 'crds/*.yaml'
    helm upgrade --reset-values --install --create-namespace --namespace ${NAMESPACE} ${RELEASE_NAME} helm_chart/ansible-operator -f /path/to/helm_values

This will apply CRD manifests to the Kubernetes cluster configured in ~/.kube/config and install the operator [helm chart](../helm_chart/ansible-operator)

To clear all resources use:

    helm --namespace ${NAMESPACE} uninstall ${RELEASE_NAME}
    kubectl delete -f 'crds/*.yaml'
    kubectl delete namespace ${NAMESPACE}

This will delete the CRDs and namespace and uninstall the helm release from the Kubernetes cluster configured in ~/.kube/config

### Documentation
* [Custom resource definitions](./CRDS.md)
* [ansible-executor ansible role](./ANSIBLE_EXECUTOR.md)
* [ansible-operator helm chart](./HELM_CHART.md)
* [Makefile](./MAKEFILE.md)
